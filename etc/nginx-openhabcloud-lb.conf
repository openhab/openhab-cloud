map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

ssl_certificate /etc/letsencrypt/live/my.YOURHOST.com/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/my.YOURHOST.com/privkey.pem;

# Socket.IO connections from openHAB instances — consistent hash by source IP
# so the same openHAB reconnects to the same Node.js instance
upstream socketapp {
	hash $remote_addr consistent;
	server 127.0.0.1:3000;
	server 127.0.0.1:3001;
	server 127.0.0.1:3002;
	server 127.0.0.1:3003;
}

# All other traffic — round-robin across all local instances
# Proxy requests use CloudServer cookie affinity (set by the app) to route
# directly to the server holding the openHAB WebSocket connection
upstream app {
	server 127.0.0.1:3000;
	server 127.0.0.1:3001;
	server 127.0.0.1:3002;
	server 127.0.0.1:3003;
}


# Redirect http -> https
server {
	listen 80 default_server;
	listen [::]:80 default_server;
	server_name my.YOURHOST.com home.YOURHOST.com;
	return 301 https://$server_name$request_uri;
}

# Full proxy for home.yourhost.com — all traffic is proxied to openHAB instances
server {
    listen 443 ssl;
    server_name home.YOURHOST.com;

    charset utf-8;

    access_log /var/log/nginx/home.openhab.org-access.log;
    error_log /var/log/nginx/home.openhab.org-error.log;
    client_max_body_size 300m;

    root /var/www/html;

    location ~ /.well-known {
      allow all;
    }

	location / {
		set $upstream_server app;
		# If we have a cookie, route directly to the server holding the connection
		if ($http_cookie ~ "CloudServer=(\S+)\%3A(\d+).*") {
			set $upstream_host $1;
			set $upstream_port $2;
			set $upstream_server "${upstream_host}:${upstream_port}";
		}
		proxy_pass http://$upstream_server;
		proxy_redirect off;
		proxy_http_version 1.1;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto https;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection $connection_upgrade;
		# If cookie-targeted server is down, fall back to local round-robin
		error_page 502 503 504 = @fallback;
	}

	location @fallback {
		proxy_pass http://app;
		proxy_redirect off;
		proxy_http_version 1.1;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto https;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection $connection_upgrade;
	}
}

# Main myopenhab.org requests — Socket.IO, proxied connections, and web UI
server {
	listen 443 ssl;
	server_name my.YOURHOST.com;

	charset utf-8;

	access_log /var/log/nginx/my.openhab.org-access.log;
	error_log /var/log/nginx/my.openhab.org-error.log;
	client_max_body_size 300m;

	root /var/www/html;

	location ~ /.well-known {
		allow all;
	}

	# Socket.IO connections from openHAB instances
	location /socket.io {
		proxy_pass http://socketapp;
		proxy_redirect off;
		proxy_http_version 1.1;
		proxy_read_timeout 10m;
		proxy_connect_timeout 10m;
		proxy_send_timeout 10m;
		proxy_set_header Host $host;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto https;
	}

	# Proxied connections from clients — cookie routing with fallback
	location ~ ^/(rest|ws|images|static|rrdchart.png|chart|openhab.app|WebApp|CMD|cometVisu|proxy|greent|jquery|classicui|ui|basicui|paperui|doc|start|icon|habmin|remote|habpanel|ifttt/v1/actions/command){
		set $upstream_server app;
		if ($http_cookie ~ "CloudServer=(\S+)\%3A(\d+).*") {
			set $upstream_host $1;
			set $upstream_port $2;
			set $upstream_server "${upstream_host}:${upstream_port}";
		}
		proxy_pass http://$upstream_server;
		proxy_redirect off;
		proxy_http_version 1.1;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto https;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection $connection_upgrade;
		# If cookie-targeted server is down, fall back to local round-robin
		error_page 502 503 504 = @fallback;
	}

	# Static assets served directly by nginx
	location /css {
		alias  /opt/openhabcloud/public/css;
	}
	location /js {
		alias /opt/openhabcloud/public/js;
	}
	location /img {
		alias /opt/openhabcloud/public/img;
	}
	location /bootstrap {
		alias /opt/openhabcloud/public/bootstrap;
	}
	location /font-icons {
		alias /opt/openhabcloud/public/font-icons;
	}
	location /fonts {
		alias /opt/openhabcloud/public/fonts;
	}
	location /js-plugin {
		alias /opt/openhabcloud/public/js-plugin;
	}
	location /staff/js-plugin {
		alias /opt/openhabcloud/public/js-plugin;
	}
	location /downloads {
		alias /opt/openhabcloud/public/downloads;
	}

	# All other non-proxy connections (web UI, account pages, etc.)
	location / {
		proxy_pass http://app;
		proxy_redirect off;
		proxy_http_version 1.1;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto https;
	}

	location @fallback {
		proxy_pass http://app;
		proxy_redirect off;
		proxy_http_version 1.1;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto https;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection $connection_upgrade;
	}
}
