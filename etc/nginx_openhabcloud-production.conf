ssl_certificate /etc/letsencrypt/live/myopenhab.org/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/myopenhab.org/privkey.pem;

## This should handle all web requests that do not proxy back to an OH
## The main application server will need to be run once per CPU on a host machine as node clustering is not ideal for it
upstream web-requests {
        server 192.168.158.18:3000;
        server 192.168.158.18:3001;
}

## This is to load balance incoming websocket connections from OH instances
## The main application server will need to be run once per CPU on a host machine as node clustering is not ideal for it
upstream socket-requests {
        ## we need to use ip_hash to lock incoming IP addresses to a single instance
        ## b/c websocket setups send multiple requests which need to go to one host
        ip_hash;
        server 192.168.158.18:3000;
        server 192.168.158.18:3001;
}

## This is the cloud director server to match incoming requests to a server which has a matching OH connection
## The proxy server will launch child clustered processes per host, so no need to run it multiple times
## on the same host
upstream proxy-requests {
        server 127.0.0.1:3000;
}

server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name myopenhab.org home.myopenhab.org;
    return 301 https://$server_name$request_uri;
}

## home.myopenhab.org
server {
    listen 443 ssl;
    server_name home.myopenhab.org;

    charset utf-8;

    access_log /var/log/nginx/home.openhab.org-access.log;
    error_log /var/log/nginx/home.openhab.org-error.log;
    client_max_body_size 300m;

    root /var/www/html;

    location ~ /.well-known {
      allow all;
    }

    #Send requests to the cloud-director process, this will return back a 302
    #with the location of the correct server
    location / {
        proxy_pass http://proxy-requests;
        #proxy_redirect off;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr ;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
        proxy_set_header X-Forwarded-Proto https;
        proxy_intercept_errors on;
        error_page 301 302 307 = @handle_proxy;
    }

    #The cloud-director process will send back a 302 with the location of the
    #server to proxy to which this will follow and proxy the original request
    location @handle_proxy {
        set $proxy_server '$upstream_http_location';
        proxy_pass $proxy_server;
        proxy_redirect off;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr ;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
        proxy_set_header X-Forwarded-Proto https;
    }
}

## myopenhab.org
server {
    listen 443 ssl;
    server_name myopenhab.org;

    charset utf-8;

    access_log /var/log/nginx/my.openhab.org-access.log;
    error_log /var/log/nginx/my.openhab.org-error.log;
    client_max_body_size 300m;

    root /var/www/html;

    location ~ /.well-known {
      allow all;
    }

location /css {
    alias  /home/openhabcloud/openhabcloud/public/css;
    }
location /js {
    alias /home/openhabcloud/openhabcloud/public/js;
    }
location /img {
    alias /home/openhabcloud/openhabcloud/public/img;
    }
location /bootstrap {
    alias /home/openhabcloud/openhabcloud/public/bootstrap;
    }
location /font-icons {
    alias /home/openhabcloud/openhabcloud/public/font-icons;
    }
location /fonts {
    alias /home/openhabcloud/openhabcloud/public/fonts;
    }
location /js-plugin {
    alias /home/openhabcloud/openhabcloud/public/js-plugin;
    }
location /downloads {
    alias /home/openhabcloud/openhabcloud/public/downloads;
    }

#Connections from OH instances, uses plain load balancing
location /socket.io {
    proxy_pass http://socket-requests;
    proxy_redirect off;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header X-Real-IP $remote_addr ;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
    proxy_set_header X-Forwarded-Proto https;
}

#Normal web requests to the openHAB Cloud app
location / {
    proxy_pass http://web-requests;
    proxy_redirect off;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr ;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
    proxy_set_header X-Forwarded-Proto https;
}

#Send requests to the cloud-director process, this will return back a 302
#with the location of the correct server
location ~ ^/(rest|images|static|rrdchart.png|chart|openhab.app|WebApp|CMD|cometVisu|proxy|greent|jquery|classicui|ui|basicui|paperui|doc|start|icon|habmin|remote|habpanel|ifttt/v1/actions/command){
    proxy_pass http://proxy-requests;
    #proxy_redirect off;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr ;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
    proxy_set_header X-Forwarded-Proto https;
    proxy_intercept_errors on;
    error_page 301 302 307 = @handle_proxy;
}


#The cloud-director process will send back a 302 with the location of the
#server to proxy to which this will follow and proxy the original request
location @handle_proxy {
    set $proxy_server '$upstream_http_location';
    proxy_pass $proxy_server;
    proxy_redirect off;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr ;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
    proxy_set_header X-Forwarded-Proto https;
}

#error_page 404 /404.html;

# redirect server error pages to the static page /50x.html
#
#error_page 500 502 503 504 /50x.html;
#location = /50x.html {
#root html;
#}
}
