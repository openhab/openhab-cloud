name: Test

on:
  pull_request:
    branches: [main]

jobs:
  lint-and-typecheck:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint:ts

      - name: Run type check
        run: npm run typecheck

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:6
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ping:1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Create logs directory
        run: mkdir -p logs

      - name: Seed test database
        run: npx tsx tests/integration/seed-database.ts
        env:
          MONGO_HOST: localhost
          MONGO_PORT: 27017
          MONGO_DB: openhab_test

      - name: Start application
        run: |
          npm start > app.log 2>&1 &
          echo $! > app.pid
          echo "App started with PID $(cat app.pid)"
        env:
          NODE_ENV: test
          CONFIG_PATH: ./docker/config.ci.json

      - name: Wait for application to be ready
        run: |
          echo "Waiting for app to start..."
          for i in {1..60}; do
            sleep 1

            # Check if process is still running
            if ! ps -p $(cat app.pid) > /dev/null 2>&1; then
              echo "=== Process died! Showing logs ==="
              cat app.log || true
              exit 1
            fi

            # Try health check
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health 2>/dev/null || echo "000")
            echo "Attempt $i: HTTP $RESPONSE"

            if [ "$RESPONSE" = "200" ]; then
              echo "Health check passed!"

              # Verify a few more endpoints work
              echo "Testing login page..."
              LOGIN_RESP=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/login 2>/dev/null || echo "000")
              echo "Login page: HTTP $LOGIN_RESP"

              # Check process is still alive after requests
              if ! ps -p $(cat app.pid) > /dev/null 2>&1; then
                echo "=== Process crashed after health check! ==="
                cat app.log || true
                exit 1
              fi

              echo "Server is ready!"
              exit 0
            fi

            # Show more detail if we get a response but not 200
            if [ "$RESPONSE" != "000" ]; then
              echo "Got response, checking body:"
              curl -s http://localhost:3000/health || true
            fi
          done

          echo "=== Timeout - showing full logs ==="
          cat app.log || true
          exit 1

      - name: Verify server before tests
        run: |
          echo "=== Pre-test verification ==="

          # Test multiple endpoints to ensure server is fully working
          for endpoint in /health /login; do
            echo "Testing $endpoint..."
            RESP=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000$endpoint)
            echo "  $endpoint: HTTP $RESP"
            if [ "$RESP" = "000" ]; then
              echo "FAILED: Server not responding to $endpoint"
              cat app.log || true
              exit 1
            fi
          done

          # Check process is still alive
          if ! ps -p $(cat app.pid) > /dev/null 2>&1; then
            echo "SERVER CRASHED after endpoint tests!"
            cat app.log || true
            exit 1
          fi

          echo "Server verified and ready for tests"

      - name: Run integration tests
        run: |
          echo "=== Application logs before tests ==="
          cat app.log || true
          echo ""
          echo "=== Starting tests ==="

          # Start log tail in background (from now on)
          tail -f app.log &
          TAIL_PID=$!

          # Multiple sanity checks to ensure server is stable
          echo "=== Stability check ==="
          for i in 1 2 3; do
            echo "Check $i..."
            curl -s http://localhost:3000/health && echo " OK"
            curl -s http://localhost:3000/login > /dev/null && echo "  /login OK"
            sleep 1
          done

          # Test a POST request like the tests do
          echo "=== Testing POST to /login (like supertest does) ==="
          curl -s -X POST http://localhost:3000/login \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "username=test@example.com&password=test" \
            -c /tmp/cookies.txt \
            -w "\n  Status: %{http_code}\n" || echo "  POST failed"

          # Check if server survived
          sleep 1
          if ! ps -p $(cat app.pid) > /dev/null 2>&1; then
            echo "SERVER CRASHED after POST!"
            echo "=== Crash log ==="
            cat app.log || true
            exit 1
          fi
          echo "  Server survived POST request"

          # Brief pause to ensure server is fully ready
          echo "Server appears stable, waiting 2s before tests..."
          sleep 2

          # Check server still alive
          if ! ps -p $(cat app.pid) > /dev/null 2>&1; then
            echo "SERVER DIED during stability checks!"
            kill $TAIL_PID 2>/dev/null || true
            exit 1
          fi

          # Run tests and capture exit code
          npm run test:integration || TEST_EXIT=$?

          # Stop log tail
          kill $TAIL_PID 2>/dev/null || true

          # Check if server is still running after tests
          echo ""
          echo "=== Checking server status after tests ==="
          if ps -p $(cat app.pid) > /dev/null 2>&1; then
            echo "Server still running (PID $(cat app.pid))"
          else
            echo "SERVER CRASHED during tests!"
            echo ""
            echo "=== Full application logs ==="
            cat app.log || true
          fi

          # Exit with test result
          exit ${TEST_EXIT:-0}
        timeout-minutes: 5
        env:
          SERVER_URL: http://127.0.0.1:3000
