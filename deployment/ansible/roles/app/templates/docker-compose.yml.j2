services:
  nginx:
    image: nginx:latest
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
{% for i in range(node_instances) %}
      oh{{ i + 1 }}:
        condition: service_started
{% endfor %}

{% for i in range(node_instances) %}
  oh{{ i + 1 }}:
    image: {{ docker_image }}
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./config.json.template:/opt/openhabcloud/config.json.template:ro
      - ./logs/oh{{ i + 1 }}:/opt/openhabcloud/logs
{% if vault_fcm_service_key_json is defined %}
      - ./serviceAccountKey.json:/opt/openhabcloud/serviceAccountKey.json:ro
{% endif %}
    environment:
      - NODE_ENV=production
      - HOST={{ ansible_host }}
      - PORT={{ 3000 + i }}
      - DOMAIN_NAME={{ domain }}
      - PROXY_HOST=home.{{ domain }}
      - PROXY_PORT=443
      - EXPRESS_KEY={{ vault_express_key }}
      - MONGO_HOST={{ hostvars['db']['ansible_host'] }}
      - MONGO_PORT=27017
      - MONGO_DB=openhab
      - MONGO_USER=openhab
      - MONGO_PASSWORD={{ vault_mongodb_password }}
      - REDIS_HOST={{ hostvars['db']['ansible_host'] }}
      - REDIS_PORT=6379
      - REDIS_PASSWORD={{ vault_redis_password }}
{% if smtp_host is defined %}
      - SMTP_HOST={{ smtp_host }}
      - SMTP_PORT={{ smtp_port | default(587) }}
      - SMTP_USER={{ smtp_user | default('') }}
      - SMTP_PASSWORD={{ vault_smtp_password | default('') }}
      - SMTP_FROM={{ smtp_from | default('') }}
{% endif %}
{% if fcm_sender_id is defined %}
      - FCM_SENDER_ID={{ fcm_sender_id }}
{% if vault_fcm_service_key_json is defined %}
      - FCM_SERVICE_FILE=/opt/openhabcloud/serviceAccountKey.json
{% else %}
      - FCM_SERVICE_FILE={{ fcm_service_file | default('') }}
{% endif %}
{% endif %}
{% if vault_ifttt_channel_key is defined %}
      - IFTTT_CHANNEL_KEY={{ vault_ifttt_channel_key }}
      - IFTTT_TEST_TOKEN={{ vault_ifttt_test_token | default('') }}
{% endif %}
      - MORGAN_FORMAT={{ morgan_format | default('') }}
      - NODE_OPTIONS=--max-old-space-size={{ node_max_old_space }}

{% endfor %}
